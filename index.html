<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Scheduler</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui,Arial;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.container{
  background:#fff;
  max-width:760px;
  width:100%;
  padding:30px;
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,.3);
}
h1{text-align:center;color:#667eea;margin-bottom:15px}
label{font-weight:600}
input,textarea{
  width:100%;
  padding:12px;
  margin:6px 0 14px;
  border-radius:10px;
  border:2px solid #ddd;
}
textarea{min-height:100px}
button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#667eea;
  color:#fff;
  cursor:pointer;
}
button.secondary{background:#888}
button.danger{background:#e74c3c}
.message{
  display:none;
  padding:10px;
  border-radius:8px;
  margin-bottom:12px;
  color:#fff;
}
.success{background:#2ecc71}
.error{background:#e74c3c}
.email-item{
  background:#f4f7fb;
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
}
.actions{margin-top:8px}
.actions button{margin-right:6px}
</style>
</head>

<body>
<div class="container">

<h1>üìß Email Scheduler</h1>
<div id="msg" class="message"></div>

<form id="emailForm">
<input type="hidden" id="editIndex">

<label>To</label>
<input type="email" id="to" required>

<label>Subject</label>
<input type="text" id="subject" required>

<label>Message</label>
<textarea id="message" required></textarea>

<label>Date</label>
<input type="date" id="date" required>

<label>Time</label>
<input type="time" id="time" required>

<button type="submit">Schedule Email</button>
<button type="button" class="secondary" onclick="resetForm()">Cancel</button>
</form>

<hr style="margin:20px 0">

<h3>Scheduled Emails</h3>
<div id="emailList"></div>

</div>

<script>
const msgBox = document.getElementById("msg");
const list = document.getElementById("emailList");
const form = document.getElementById("emailForm");

let emails = JSON.parse(localStorage.getItem("emails")) || [];

function showMsg(text,type){
  msgBox.textContent=text;
  msgBox.className="message "+type;
  msgBox.style.display="block";
  setTimeout(()=>msgBox.style.display="none",4000);
}

function save(){ localStorage.setItem("emails",JSON.stringify(emails)); }

function resetForm(){
  form.reset();
  editIndex.value="";
}

function render(){
  list.innerHTML="";
  if(!emails.length){
    list.innerHTML="<p>No scheduled emails</p>";
    return;
  }
  emails.forEach((e,i)=>{
    list.innerHTML+=`
      <div class="email-item">
        <b>To:</b> ${e.to}<br>
        <b>Subject:</b> ${e.subject}<br>
        <b>Time:</b> ${e.date} ${e.time}<br>
        <b>Status:</b> ${e.status==="sent"?"‚úÖ Sent":"‚è≥ Pending"}
        <div class="actions">
          ${
            e.status==="pending"
            ? `<button onclick="deleteEmail(${i})" class="danger">Delete</button>`
            : `<button disabled class="danger">Delete</button>`
          }
        </div>
      </div>
    `;
  });
}

function deleteEmail(i){
  if(emails[i].status==="sent"){
    showMsg("Sent emails cannot be deleted","error");
    return;
  }
  emails.splice(i,1);
  save();
  render();
}

function sendEmail(e){
  fetch("/api/sendMail",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      to_email:e.to,
      subject:e.subject,
      message:e.message,
      sender_name:"A S Shridatta Aigal"
    })
  })
  .then(res=>res.json())
  .then(()=>{
    e.status="sent";
    save();
    render();
    showMsg("Email sent successfully ‚úÖ","success");
  })
  .catch(()=>{
    showMsg("Email sending failed ‚ùå","error");
  });
}

function checkEmails(){
  const now = new Date();
  emails.forEach(e=>{
    if(e.status==="pending"){
      const t = new Date(`${e.date}T${e.time}`);
      if(now>=t) sendEmail(e);
    }
  });
}

form.addEventListener("submit",ev=>{
  ev.preventDefault();
  emails.push({
    to:to.value,
    subject:subject.value,
    message:message.value,
    date:date.value,
    time:time.value,
    status:"pending"
  });
  save();
  render();
  resetForm();
  showMsg("Email scheduled üéØ","success");
});

setInterval(checkEmails,30000);
render();
checkEmails();
</script>
</body>
</html>
